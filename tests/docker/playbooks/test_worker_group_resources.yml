---
- name: Test Worker Group Support Across Multiple Resource Types
  hosts: localhost
  gather_facts: false
  vars:
    cribl_url: "{{ lookup('env', 'CRIBL_URL') | default('http://localhost:9000', true) }}"
    cribl_username: "{{ lookup('env', 'CRIBL_USERNAME') | default('admin', true) }}"
    cribl_password: "{{ lookup('env', 'CRIBL_PASSWORD') }}"
    cribl_client_id: "{{ lookup('env', 'CRIBL_CLIENT_ID') | default(false) }}"
    cribl_client_secret: "{{ lookup('env', 'CRIBL_CLIENT_SECRET') | default(false) }}"
    test_suffix: "{{ 99999999 | random | to_uuid | string | split('-') | last }}"
    test_group: "test_multi_{{ test_suffix }}"
  
  tasks:
    - name: Create Cribl authentication session (username/password)
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        username: "{{ cribl_username }}"
        password: "{{ cribl_password }}"
        validate_certs: false 
      register: cribl_session
      no_log: true
      when: cribl_client_id is string== false
    
    - name: Create Cribl authentication session (cribl.cloud)
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        client_id: "{{ cribl_client_id }}"
        client_secret: "{{ cribl_client_secret }}"
        validate_certs: true
      register: cribl_session
      no_log: true
      when: cribl_client_id is string


    # ==================================
    # Setup Worker Group
    # ==================================
    
    - name: "========== SETUP WORKER GROUP =========="
      debug:
        msg: "Creating test worker group: {{ test_group }}"

    - name: Create test worker group
      cribl.core.worker_group:
        session: "{{ cribl_session.session }}"
        id: "{{ test_group }}"
        description: "Multi-resource test worker group"
        state: present
      register: wg_create
      ignore_errors: true

    - name: Set worker groups available flag
      set_fact:
        wg_available: "{{ wg_create is succeeded }}"

    - name: Display worker group status
      debug:
        msg: "{{ 'Worker group created successfully' if wg_available else 'Worker groups not available (single-instance mode)' }}"

    # ==================================
    # Test Pipeline
    # ==================================
    
    - name: "========== TEST: PIPELINE =========="
      debug:
        msg: "Testing pipeline with worker_group parameter"
      when: wg_available

    - name: Create pipeline in worker group
      cribl.stream.pipeline:
        session: "{{ cribl_session.session }}"
        id: "test_multi_pipeline"
        worker_group: "{{ test_group }}"
        conf:
          description: "Multi-resource test pipeline"
          asyncFuncTimeout: 1000
        state: present
      register: pipeline_test
      when: wg_available

    - name: Verify pipeline
      debug:
        msg: "✓ Pipeline: {{ 'PASSED' if (pipeline_test.changed) else 'FAILED' }}"
      when: wg_available and pipeline_test is defined

    # ==================================
    # Test Input
    # ==================================
    
    - name: "========== TEST: INPUT =========="
      debug:
        msg: "Testing input with worker_group parameter"
      when: wg_available

    - name: Create input in worker group
      cribl.stream.input:
        session: "{{ cribl_session.session }}"
        id: "test_multi_input"
        worker_group: "{{ test_group }}"
        state: present
        conf:
          type: syslog
          host: 0.0.0.0
          tcpPort: 5514
          disabled: false
      register: input_test
      when: wg_available
      ignore_errors: true

    - name: Verify input
      debug:
        msg: "✓ Input: {{ 'PASSED' if (input_test is succeeded and input_test.changed) else 'FAILED' }}"
      when: wg_available and input_test is defined

    # ==================================
    # Test Output
    # ==================================
    
    - name: "========== TEST: OUTPUT =========="
      debug:
        msg: "Testing output with worker_group parameter"
      when: wg_available

    - name: Create output in worker group
      cribl.stream.output:
        session: "{{ cribl_session.session }}"
        id: "test_multi_output"
        worker_group: "{{ test_group }}"
        state: present
        conf:
          type: s3
          bucket: test-multi-bucket
          region: us-east-1
          destPath: logs/
          format: json
      register: output_test
      when: wg_available
      ignore_errors: true

    - name: Verify output
      debug:
        msg: "✓ Output: {{ 'PASSED' if (output_test is succeeded and output_test.changed) else 'FAILED' }}"
      when: wg_available and output_test is defined

    # ==================================
    # Test Route
    # ==================================
    
    - name: "========== TEST: ROUTE =========="
      debug:
        msg: "Testing route with worker_group parameter"
      when: wg_available

    - name: Create route in worker group
      cribl.stream.route:
        session: "{{ cribl_session.session }}"
        id: "test_multi_route"
        worker_group: "{{ test_group }}"
        state: present
      register: route_test
      when: wg_available
      ignore_errors: true

    - name: Verify route
      debug:
        msg: "✓ Route: {{ 'PASSED' if (route_test is succeeded and route_test.changed) else 'FAILED' }}"
      when: wg_available and route_test is defined

    # ==================================
    # Test Variable
    # ==================================
    
    - name: "========== TEST: VARIABLE =========="
      debug:
        msg: "Testing variable with worker_group parameter"
      when: wg_available

    - name: Create variable in worker group
      cribl.stream.var:
        session: "{{ cribl_session.session }}"
        id: "test_multi_var"
        worker_group: "{{ test_group }}"
        type: string
        lib: "custom"
        value: "test_value"
        state: present
      register: var_test
      when: wg_available
      ignore_errors: true

    - name: Verify variable
      debug:
        msg: "✓ Variable: {{ 'PASSED' if (var_test is succeeded and var_test.changed) else 'FAILED' }}"
      when: wg_available and var_test is defined

    # ==================================
    # Test Pack
    # ==================================
    
    - name: "========== TEST: PACK =========="
      debug:
        msg: "Testing pack with worker_group parameter"
      when: wg_available

    - name: Create pack in worker group
      cribl.stream.pack:
        session: "{{ cribl_session.session }}"
        id: "test_multi_pack"
        worker_group: "{{ test_group }}"
        state: present
      register: pack_test
      when: wg_available
      ignore_errors: true

    - name: Verify pack
      debug:
        msg: "✓ Pack: {{ 'PASSED' if (pack_test is succeeded and pack_test.changed) else 'FAILED' }}"
      when: wg_available and pack_test is defined

    # ==================================
    # Test Parser
    # ==================================
    
    - name: "========== TEST: PARSER =========="
      debug:
        msg: "Testing parser with worker_group parameter"
      when: wg_available

    - name: Create parser in worker group
      cribl.stream.parser:
        session: "{{ cribl_session.session }}"
        id: "test_multi_parser"
        worker_group: "{{ test_group }}"
        type: csv
        state: present
      register: parser_test
      when: wg_available
      ignore_errors: true

    - name: Verify parser
      debug:
        msg: "✓ Parser: {{ 'PASSED' if (parser_test is succeeded and parser_test.changed) else 'FAILED' }}"
      when: wg_available and parser_test is defined

    # ==================================
    # Test Schema
    # ==================================
    
    - name: "========== TEST: SCHEMA =========="
      debug:
        msg: "Testing schema with worker_group parameter"
      when: wg_available

    - name: Create schema in worker group
      cribl.stream.schema:
        session: "{{ cribl_session.session }}"
        id: "test_multi_schema"
        worker_group: "{{ test_group }}"
        state: present
      register: schema_test
      when: wg_available
      ignore_errors: true

    - name: Verify schema
      debug:
        msg: "✓ Schema: {{ 'PASSED' if (schema_test is succeeded and schema_test.changed) else 'FAILED' }}"
      when: wg_available and schema_test is defined

    # ==================================
    # Test Breaker
    # ==================================
    
    - name: "========== TEST: BREAKER =========="
      debug:
        msg: "Testing breaker with worker_group parameter"
      when: wg_available

    - name: Create breaker in worker group
      cribl.stream.breaker:
        session: "{{ cribl_session.session }}"
        id: "test_multi_breaker"
        worker_group: "{{ test_group }}"
        type: regex
        state: present
      register: breaker_test
      when: wg_available
      ignore_errors: true

    - name: Verify breaker
      debug:
        msg: "✓ Breaker: {{ 'PASSED' if (breaker_test is succeeded and breaker_test.changed) else 'FAILED' }}"
      when: wg_available and breaker_test is defined

    # ==================================
    # Test Grok Pattern
    # ==================================
    
    - name: "========== TEST: GROK =========="
      debug:
        msg: "Testing grok with worker_group parameter"
      when: wg_available

    - name: Create grok pattern in worker group
      cribl.stream.grok:
        session: "{{ cribl_session.session }}"
        id: "test_multi_grok"
        worker_group: "{{ test_group }}"
        description: "Test grok pattern"
        state: present
      register: grok_test
      when: wg_available
      ignore_errors: true

    - name: Verify grok
      debug:
        msg: "✓ Grok: {{ 'PASSED' if (grok_test is succeeded and grok_test.changed) else 'FAILED' }}"
      when: wg_available and grok_test is defined

    # ==================================
    # Test Regex Pattern
    # ==================================
    
    - name: "========== TEST: REGEX =========="
      debug:
        msg: "Testing regex with worker_group parameter"
      when: wg_available

    - name: Create regex pattern in worker group
      cribl.stream.regex:
        session: "{{ cribl_session.session }}"
        id: "test_multi_regex"
        worker_group: "{{ test_group }}"
        lib: "custom"
        regex: ".*test.*"
        state: present
      register: regex_test
      when: wg_available
      ignore_errors: true

    - name: Verify regex
      debug:
        msg: "✓ Regex: {{ 'PASSED' if (regex_test is succeeded and regex_test.changed) else 'FAILED' }}"
      when: wg_available and regex_test is defined

    # ==================================
    # Cleanup All Resources
    # ==================================
    
    - name: "========== CLEANUP =========="
      debug:
        msg: "Cleaning up all test resources"
      when: wg_available

    - name: Delete pipeline
      cribl.stream.pipeline:
        session: "{{ cribl_session.session }}"
        id: "test_multi_pipeline"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and pipeline_test is succeeded
      ignore_errors: true

    - name: Delete input
      cribl.stream.input:
        session: "{{ cribl_session.session }}"
        id: "test_multi_input"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and input_test is succeeded
      ignore_errors: true

    - name: Delete output
      cribl.stream.output:
        session: "{{ cribl_session.session }}"
        id: "test_multi_output"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and output_test is succeeded
      ignore_errors: true

    - name: Delete route
      cribl.stream.route:
        session: "{{ cribl_session.session }}"
        id: "test_multi_route"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and route_test is succeeded
      ignore_errors: true

    - name: Delete variable
      cribl.stream.var:
        session: "{{ cribl_session.session }}"
        id: "test_multi_var"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and var_test is succeeded
      ignore_errors: true

    - name: Delete pack
      cribl.stream.pack:
        session: "{{ cribl_session.session }}"
        id: "test_multi_pack"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and pack_test is succeeded
      ignore_errors: true

    - name: Delete parser
      cribl.stream.parser:
        session: "{{ cribl_session.session }}"
        id: "test_multi_parser"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and parser_test is succeeded
      ignore_errors: true

    - name: Delete schema
      cribl.stream.schema:
        session: "{{ cribl_session.session }}"
        id: "test_multi_schema"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and schema_test is succeeded
      ignore_errors: true

    - name: Delete breaker
      cribl.stream.breaker:
        session: "{{ cribl_session.session }}"
        id: "test_multi_breaker"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and breaker_test is succeeded
      ignore_errors: true

    - name: Delete grok
      cribl.stream.grok:
        session: "{{ cribl_session.session }}"
        id: "test_multi_grok"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and grok_test is succeeded
      ignore_errors: true

    - name: Delete regex
      cribl.stream.regex:
        session: "{{ cribl_session.session }}"
        id: "test_multi_regex"
        worker_group: "{{ test_group }}"
        state: absent
      when: wg_available and regex_test is succeeded
      ignore_errors: true

    - name: Delete worker group
      cribl.core.worker_group:
        session: "{{ cribl_session.session }}"
        id: "{{ test_group }}"
        state: absent
      when: wg_available
      ignore_errors: true

    # ==================================
    # Test Summary
    # ==================================
    
    - name: "========== TEST SUMMARY =========="
      debug:
        msg:
          - "=============================================="
          - "Worker Group Multi-Resource Test Summary"
          - "=============================================="
          - "Worker Groups: {{ 'AVAILABLE' if wg_available else 'NOT AVAILABLE' }}"
          - ""
          - "Resource Tests (with worker_group parameter):"
          - "  Pipeline:  {{ 'PASSED' if (pipeline_test is succeeded and pipeline_test.changed) else 'SKIP/FAIL' }}"
          - "  Input:     {{ 'PASSED' if (input_test is succeeded and input_test.changed) else 'SKIP/FAIL' }}"
          - "  Output:    {{ 'PASSED' if (output_test is succeeded and output_test.changed) else 'SKIP/FAIL' }}"
          - "  Route:     {{ 'PASSED' if (route_test is succeeded and route_test.changed) else 'SKIP/FAIL' }}"
          - "  Variable:  {{ 'PASSED' if (var_test is succeeded and var_test.changed) else 'SKIP/FAIL' }}"
          - "  Pack:      {{ 'PASSED' if (pack_test is succeeded and pack_test.changed) else 'SKIP/FAIL' }}"
          - "  Parser:    {{ 'PASSED' if (parser_test is succeeded and parser_test.changed) else 'SKIP/FAIL' }}"
          - "  Schema:    {{ 'PASSED' if (schema_test is succeeded and schema_test.changed) else 'SKIP/FAIL' }}"
          - "  Breaker:   {{ 'PASSED' if (breaker_test is succeeded and breaker_test.changed) else 'SKIP/FAIL' }}"
          - "  Grok:      {{ 'PASSED' if (grok_test is succeeded and grok_test.changed) else 'SKIP/FAIL' }}"
          - "  Regex:     {{ 'PASSED' if (regex_test is succeeded and regex_test.changed) else 'SKIP/FAIL' }}"
          - ""
          - "All declarative modules support worker_group parameter!"
          - "=============================================="

