---
- name: Test Cribl Health and Status Checks
  hosts: localhost
  gather_facts: false
  vars:
    cribl_url: "{{ lookup('env', 'CRIBL_URL') | default('http://localhost:9000', true) }}"
    cribl_username: "{{ lookup('env', 'CRIBL_USERNAME') | default('admin', true) }}"
    cribl_password: "{{ lookup('env', 'CRIBL_PASSWORD') }}"
    cribl_client_id: "{{ lookup('env', 'CRIBL_CLIENT_ID') | default(false) }}"
    cribl_client_secret: "{{ lookup('env', 'CRIBL_CLIENT_SECRET') | default(false) }}"
  
  tasks:
    - name: Create Cribl authentication session (username/password)
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        username: "{{ cribl_username }}"
        password: "{{ cribl_password }}"
        validate_certs: false 
      register: cribl_session
      no_log: true
      when: cribl_client_id is string== false
    
    - name: Create Cribl authentication session (cribl.cloud)
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        client_id: "{{ cribl_client_id }}"
        client_secret: "{{ cribl_client_secret }}"
        validate_certs: true
      register: cribl_session
      no_log: true
      when: cribl_client_id is string

    - name: Check system health
      cribl.core.health_get:
        session: "{{ cribl_session.session }}"
      register: health_check

    - name: Display health status
      debug:
        var: health_check.response

    - name: Verify health check succeeded
      assert:
        that:
          - health_check is succeeded
        success_msg: "Health check passed"
        fail_msg: "Health check failed"

    - name: Get input status
      cribl.core.system_status_inputs_get:
        session: "{{ cribl_session.session }}"
      register: input_status
      ignore_errors: true

    - name: Display input status
      debug:
        msg: "Inputs: {{ input_status.response.count | default(0) }} found"
      when: input_status is succeeded

    - name: Get output status
      cribl.core.system_status_outputs_get:
        session: "{{ cribl_session.session }}"
      register: output_status
      ignore_errors: true

    - name: Display output status
      debug:
        msg: "Outputs: {{ output_status.response.count | default(0) }} found"
      when: output_status is succeeded

    - name: Get system licenses
      cribl.core.system_licenses_get:
        session: "{{ cribl_session.session }}"
      register: licenses
      ignore_errors: true

    - name: Display license information
      debug:
        var: licenses.response
      when: licenses is succeeded

    - name: Test summary
      debug:
        msg:
          - "===== Cribl Health Check Summary ====="
          - "Health Status: {{ 'OK' if health_check is succeeded else 'FAILED' }}"
          - "Inputs Checked: {{ 'YES' if input_status is succeeded else 'NO' }}"
          - "Outputs Checked: {{ 'YES' if output_status is succeeded else 'NO' }}"
          - "License Info: {{ 'Retrieved' if licenses is succeeded else 'N/A' }}"

