---
- name: Test Cribl Core User Declarative Module
  hosts: localhost
  gather_facts: false
  vars:
    cribl_url: "{{ lookup('env', 'CRIBL_URL') | default('http://localhost:9000', true) }}"
    cribl_username: "{{ lookup('env', 'CRIBL_USERNAME') | default('admin', true) }}"
    cribl_password: "{{ lookup('env', 'CRIBL_PASSWORD') }}"
    test_user_id: "test_declarative_user"
  
  tasks:
    - name: Create Cribl authentication session
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        username: "{{ cribl_username }}"
        password: "{{ cribl_password }}"
      register: cribl_session
      no_log: true

    - name: "========== USER CRUD TESTS WITH DECLARATIVE MODULE =========="
      debug:
        msg: "Testing Cribl Core User declarative module (clean name: cribl.core.user)"

    # CREATE
    - name: Create test user (declarative)
      cribl.core.user:
        session: "{{ cribl_session.session }}"
        id: "{{ test_user_id }}"
        email: "{{ test_user_id }}@example.com"
        first: "Test"
        last: "User"
        roles: ["user"]
        state: present
        validate_certs: false
      register: user_create

    - name: Display user create result
      debug:
        var: user_create

    - name: Verify user was created
      assert:
        that:
          - user_create.changed == true
        fail_msg: "User was not created"
        success_msg: "✓ User created successfully"
      when: user_create is succeeded

    # IDEMPOTENCY TEST
    - name: Create same user again (should be idempotent)
      cribl.core.user:
        session: "{{ cribl_session.session }}"
        id: "{{ test_user_id }}"
        email: "{{ test_user_id }}@example.com"
        first: "Test"
        last: "User"
        roles: ["user"]
        state: present
        validate_certs: false
      register: user_idempotent
      when: user_create is succeeded

    - name: Display idempotency result
      debug:
        var: user_idempotent
      when: user_idempotent is not skipped

    - name: Verify user creation is idempotent
      assert:
        that:
          - user_idempotent.changed == false
        fail_msg: "User is NOT idempotent!"
        success_msg: "✓ User is idempotent"
      when: user_idempotent is succeeded

    # CLEANUP
    - name: Delete test user
      cribl.core.user:
        session: "{{ cribl_session.session }}"
        id: "{{ test_user_id }}"
        state: absent
        validate_certs: false
      register: user_delete
      when: user_create is succeeded

    - name: Display delete result
      debug:
        var: user_delete
      when: user_delete is not skipped

    - name: Verify user was deleted
      assert:
        that:
          - user_delete.changed == true
        fail_msg: "User was not deleted"
        success_msg: "✓ User deleted successfully"
      when: user_delete is succeeded

    # IDEMPOTENCY TEST - Delete again
    - name: Delete same user again (should be idempotent)
      cribl.core.user:
        session: "{{ cribl_session.session }}"
        id: "{{ test_user_id }}"
        state: absent
        validate_certs: false
      register: user_delete_idempotent
      when: user_delete is succeeded

    - name: Verify deletion is idempotent
      assert:
        that:
          - user_delete_idempotent.changed == false
        fail_msg: "User deletion is NOT idempotent!"
        success_msg: "✓ User deletion is idempotent"
      when: user_delete_idempotent is succeeded

    # SUMMARY
    - name: User Test Summary
      debug:
        msg:
          - "========================================="
          - "User Declarative Module Test Summary"
          - "========================================="
          - "✓ Create: {{ 'PASSED' if (user_create is succeeded and user_create.changed) else 'FAILED' }}"
          - "✓ Idempotency (create): {{ 'PASSED' if (user_idempotent is succeeded and not user_idempotent.changed) else 'FAILED/SKIP' }}"
          - "✓ Delete: {{ 'PASSED' if (user_delete is succeeded and user_delete.changed) else 'FAILED/SKIP' }}"
          - "✓ Idempotency (delete): {{ 'PASSED' if (user_delete_idempotent is succeeded and not user_delete_idempotent.changed) else 'FAILED/SKIP' }}"
          - "========================================="

