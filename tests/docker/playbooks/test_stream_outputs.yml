---
- name: Test Cribl Stream Output Declarative Module
  hosts: localhost
  gather_facts: false
  vars:
    cribl_url: "{{ lookup('env', 'CRIBL_URL') | default('http://localhost:9000', true) }}"
    cribl_username: "{{ lookup('env', 'CRIBL_USERNAME') | default('admin', true) }}"
    cribl_password: "{{ lookup('env', 'CRIBL_PASSWORD') }}"
    cribl_client_id: "{{ lookup('env', 'CRIBL_CLIENT_ID') | default(false) }}"
    cribl_client_secret: "{{ lookup('env', 'CRIBL_CLIENT_SECRET') | default(false) }}"
    test_output_id: "test_ansible_output"
  tasks:
    - name: Create Cribl authentication session (username/password)
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        username: "{{ cribl_username }}"
        password: "{{ cribl_password }}"
        validate_certs: false 
      register: cribl_session
      no_log: true
      when: cribl_client_id is string== false
    
    - name: Create Cribl authentication session (cribl.cloud)
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        client_id: "{{ cribl_client_id }}"
        client_secret: "{{ cribl_client_secret }}"
        validate_certs: true
      register: cribl_session
      no_log: true
      when: cribl_client_id is string
    - name: "========== OUTPUT CRUD TESTS =========="
      debug:
        msg: "Testing Cribl Stream Output declarative module"

    # CREATE
    - name: Create test output (declarative)
      cribl.stream.output:
        session: "{{ cribl_session.session }}"
        id: "{{ test_output_id }}"
        type: devnull
        state: present
      register: output_create
      ignore_errors: true

    - name: Verify output was created
      assert:
        that:
          - output_create.changed == true or output_create.failed == false
        fail_msg: "Output creation failed"
        success_msg: "✓ Output created successfully"
      when: output_create is succeeded

    # IDEMPOTENCY TEST
    - name: Create same output again (should be idempotent)
      cribl.stream.output:
        session: "{{ cribl_session.session }}"
        id: "{{ test_output_id }}"
        type: devnull
        state: present
      register: output_idempotent
      ignore_errors: true
      when: output_create is succeeded

    - name: Verify output creation is idempotent
      assert:
        that:
          - output_idempotent.changed == false
        fail_msg: "Output is NOT idempotent!"
        success_msg: "✓ Output is idempotent"
      when: output_create is succeeded and output_idempotent is succeeded

    # READ
    - name: List all outputs
      cribl.stream.system_outputs_get:
        session: "{{ cribl_session.session }}"
      register: outputs_list
      ignore_errors: true

    - name: Display output count
      debug:
        msg: "Total outputs: {{ outputs_list.response.count | default(0) }}"
      when: outputs_list is succeeded

    # CLEANUP
    - name: Delete test output
      cribl.stream.output:
        session: "{{ cribl_session.session }}"
        id: "{{ test_output_id }}"
        state: absent
      register: output_delete
      ignore_errors: true
      when: output_create is succeeded

    - name: Verify output was deleted
      assert:
        that:
          - output_delete.changed == true or output_delete.failed == false
        fail_msg: "Output deletion failed"
        success_msg: "✓ Output deleted successfully"
      when: output_delete is succeeded

    # IDEMPOTENCY TEST
    - name: Delete same output again (should be idempotent)
      cribl.stream.output:
        session: "{{ cribl_session.session }}"
        id: "{{ test_output_id }}"
        state: absent
      register: output_delete_idempotent
      ignore_errors: true
      when: output_delete is succeeded

    - name: Verify deletion is idempotent
      assert:
        that:
          - output_delete_idempotent.changed == false
        fail_msg: "Output deletion is NOT idempotent!"
        success_msg: "✓ Output deletion is idempotent"
      when: output_delete_idempotent is succeeded

    # SUMMARY
    - name: Output Test Summary
      debug:
        msg:
          - "========================================="
          - "Output Declarative Module Test Summary"
          - "========================================="
          - "✓ Create: {{ 'PASSED' if (output_create is succeeded) else 'FAILED' }}"
          - "✓ Idempotency (create): {{ 'PASSED' if (output_idempotent is succeeded and not output_idempotent.changed) else 'FAILED' }}"
          - "✓ List: {{ 'PASSED' if (outputs_list is succeeded) else 'FAILED' }}"
          - "✓ Delete: {{ 'PASSED' if (output_delete is succeeded) else 'FAILED' }}"
          - "✓ Idempotency (delete): {{ 'PASSED' if (output_delete_idempotent is succeeded and not output_delete_idempotent.changed) else 'FAILED' }}"
          - "========================================="

