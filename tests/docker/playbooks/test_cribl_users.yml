---
- name: Test Cribl User Management
  hosts: localhost
  gather_facts: false
  vars:
    cribl_url: "{{ lookup('env', 'CRIBL_URL') | default('http://localhost:9000', true) }}"
    cribl_username: "{{ lookup('env', 'CRIBL_USERNAME') | default('admin', true) }}"
    cribl_password: "{{ lookup('env', 'CRIBL_PASSWORD') }}"
    cribl_client_id: "{{ lookup('env', 'CRIBL_CLIENT_ID') | default(false) }}"
    cribl_client_secret: "{{ lookup('env', 'CRIBL_CLIENT_SECRET') | default(false) }}"
    test_user_id: "ansible_test_user_{{ 999999 | random }}"
  
  tasks:
    - name: Create Cribl authentication session (username/password)
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        username: "{{ cribl_username }}"
        password: "{{ cribl_password }}"
        validate_certs: false 
      register: cribl_session
      no_log: true
      when: cribl_client_id is string== false
    
    - name: Create Cribl authentication session (cribl.cloud)
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        client_id: "{{ cribl_client_id }}"
        client_secret: "{{ cribl_client_secret }}"
        validate_certs: true
      register: cribl_session
      no_log: true
      when: cribl_client_id is string

    - name: List all existing users
      cribl.core.system_users_get:
        session: "{{ cribl_session.session }}"
      register: users_list

    - name: Display current users
      debug:
        msg: "Found {{ users_list.response.count | default(0) }} users"

    - name: Create test user
      cribl.core.system_users_post:
        session: "{{ cribl_session.session }}"
        id: "{{ test_user_id }}"
        email: "{{ test_user_id }}@test.local"
        first: "Test"
        last: "User"
        roles: ["user"]
        disabled: false
      register: user_create
      ignore_errors: true

    - name: Display user creation result
      debug:
        msg: "User creation status: {{ user_create.status | default('unknown') }}"

    - name: Get specific user details
      cribl.core.system_users_id_get:
        session: "{{ cribl_session.session }}"
        id: "{{ test_user_id }}"
      register: user_details
      when: user_create is succeeded
      ignore_errors: true

    - name: Display user details
      debug:
        var: user_details.response
      when: user_details is succeeded

    - name: Clean up - Delete test user
      cribl.core.system_users_id_delete:
        session: "{{ cribl_session.session }}"
        id: "{{ test_user_id }}"
      when: user_create is succeeded
      ignore_errors: true
      register: user_delete

    - name: Display cleanup result
      debug:
        msg: "User cleanup completed"
      when: user_delete is succeeded

