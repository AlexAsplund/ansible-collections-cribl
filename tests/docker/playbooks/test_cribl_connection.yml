---
- name: Test Cribl Connection and Basic Operations
  hosts: localhost
  gather_facts: false
  vars:
    cribl_url: "{{ lookup('env', 'CRIBL_URL') | default('http://localhost:9000', true) }}"
    cribl_username: "{{ lookup('env', 'CRIBL_USERNAME') | default('admin', true) }}"
    cribl_password: "{{ lookup('env', 'CRIBL_PASSWORD') }}"
    cribl_client_id: "{{ lookup('env', 'CRIBL_CLIENT_ID') | default(false) }}"
    cribl_client_secret: "{{ lookup('env', 'CRIBL_CLIENT_SECRET') | default(false) }}"
  
  tasks:
    - name: Create Cribl authentication session (username/password)
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        username: "{{ cribl_username }}"
        password: "{{ cribl_password }}"
        validate_certs: false 
      register: cribl_session
      no_log: true
      when: cribl_client_id is string== false
    
    - name: Create Cribl authentication session (cribl.cloud)
      cribl.core.auth_session:
        base_url: "{{ cribl_url }}"
        client_id: "{{ cribl_client_id }}"
        client_secret: "{{ cribl_client_secret }}"
        validate_certs: true
      register: cribl_session
      no_log: true
      when: cribl_client_id is string

    - name: Test connection - Get system instance information
      cribl.core.system_instance_get:
        session: "{{ cribl_session.session }}"
      register: instance_info

    - name: Display Cribl instance information
      debug:
        msg:
          - "Cribl version: {{ instance_info.response.version | default('unknown') }}"
          - "Product: {{ instance_info.response.product | default('unknown') }}"
          - "GUID: {{ instance_info.response.guid | default('unknown') }}"

    - name: Verify instance info was retrieved
      assert:
        that:
          - instance_info is succeeded
          - instance_info.response is defined
        success_msg: "Successfully connected to Cribl instance"
        fail_msg: "Failed to retrieve instance information"

