name: Check Cribl API Version

on:
  schedule:
    # Run every Wednesday at 10:00 UTC
    - cron: '0 10 * * 3'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for tags
      
      - name: Fetch Cribl docs page
        id: fetch-docs
        run: |
          echo "Fetching Cribl API docs page..."
          DOCS_URL="https://docs.cribl.io/cribl-as-code/api-reference/control-plane/cribl-core/"
          curl -s "$DOCS_URL" -o cribl-docs.html
          
          if [ ! -s cribl-docs.html ]; then
            echo "Error: Failed to fetch docs page"
            exit 1
          fi
          
          echo "âœ“ Docs page fetched successfully"
      
      - name: Extract API spec URL and version
        id: extract-version
        run: |
          # Extract ALL API spec URLs using the provided regex
          echo "Searching for all Cribl API spec URLs..."
          SPEC_URLS=$(grep -oP 'https://[^"]+/cribl-apidocs-\d+\.\d+\.\d+-[a-f0-9]+\.yml' cribl-docs.html)
          
          if [ -z "$SPEC_URLS" ]; then
            echo "Error: Could not find any API spec URLs in docs page"
            echo "Searching for any apidocs URL..."
            grep -o 'https://[^"]*apidocs[^"]*\.yml' cribl-docs.html || true
            exit 1
          fi
          
          echo "Found API spec URLs:"
          echo "$SPEC_URLS"
          echo ""
          
          # Extract versions and find the highest one
          HIGHEST_VERSION="0.0.0"
          HIGHEST_URL=""
          
          while IFS= read -r URL; do
            # Extract version from URL (format: cribl-apidocs-X.Y.Z-hash.yml)
            CURRENT_VERSION=$(echo "$URL" | grep -oP 'cribl-apidocs-\K\d+\.\d+\.\d+')
            
            if [ -n "$CURRENT_VERSION" ]; then
              echo "Found version: $CURRENT_VERSION"
              
              # Compare versions using sort -V
              if [ "$(printf '%s\n%s' "$HIGHEST_VERSION" "$CURRENT_VERSION" | sort -V | tail -1)" = "$CURRENT_VERSION" ]; then
                HIGHEST_VERSION="$CURRENT_VERSION"
                HIGHEST_URL="$URL"
              fi
            fi
          done <<< "$SPEC_URLS"
          
          if [ -z "$HIGHEST_URL" ]; then
            echo "Error: Could not extract version from any URL"
            exit 1
          fi
          
          # Extract hash from the highest version URL
          HASH=$(echo "$HIGHEST_URL" | grep -oP 'cribl-apidocs-\d+\.\d+\.\d+-\K[a-f0-9]+')
          
          echo ""
          echo "âœ“ Selected highest version: $HIGHEST_VERSION"
          echo "âœ“ Spec URL: $HIGHEST_URL"
          echo "âœ“ Hash: $HASH"
          
          # Save to outputs
          echo "spec_url=$HIGHEST_URL" >> $GITHUB_OUTPUT
          echo "version=$HIGHEST_VERSION" >> $GITHUB_OUTPUT
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "full_version=${HIGHEST_VERSION}-${HASH}" >> $GITHUB_OUTPUT
      
      - name: Get latest release version
        id: latest-release
        run: |
          # Get the latest git tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          
          # Remove 'v' prefix if present
          LATEST_VERSION=${LATEST_TAG#v}
          
          echo "Latest release version: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
      
      - name: Compare versions
        id: compare
        run: |
          CURRENT_VERSION="${{ steps.extract-version.outputs.version }}"
          LATEST_VERSION="${{ steps.latest-release.outputs.latest_version }}"
          
          echo "Current API version: $CURRENT_VERSION"
          echo "Latest release version: $LATEST_VERSION"
          
          # Function to compare semantic versions
          version_gt() {
            test "$(printf '%s\n' "$@" | sort -V | head -n 1)" != "$1"
          }
          
          if version_gt "$CURRENT_VERSION" "$LATEST_VERSION"; then
            echo "ðŸŽ‰ New version available: $CURRENT_VERSION > $LATEST_VERSION"
            echo "needs_build=true" >> $GITHUB_OUTPUT
          else
            echo "âœ“ No new version. Current: $CURRENT_VERSION, Latest: $LATEST_VERSION"
            echo "needs_build=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Trigger build-release workflow
        if: steps.compare.outputs.needs_build == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const specUrl = '${{ steps.extract-version.outputs.spec_url }}';
            const version = '${{ steps.extract-version.outputs.version }}';
            
            console.log(`ðŸš€ Triggering build-release workflow for version ${version}`);
            console.log(`   Spec URL: ${specUrl}`);
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-release.yml',
              ref: 'main',
              inputs: {
                schema_url: specUrl
              }
            });
            
            console.log('âœ“ Build workflow triggered successfully');
            
            // Post a comment or create an issue to track the build
            core.summary
              .addHeading('ðŸŽ‰ New Cribl API Version Detected')
              .addRaw(`
                **New Version**: \`${version}\`
                **Spec URL**: ${specUrl}
                **Action**: Triggered build-release workflow
                
                Check the [Actions tab](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/build-release.yml) to monitor the build progress.
              `)
              .write();
      
      - name: No build needed notification
        if: steps.compare.outputs.needs_build == 'false'
        run: |
          echo "## âœ“ No Update Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Current API version (\`${{ steps.extract-version.outputs.version }}\`) is not newer than latest release (\`${{ steps.latest-release.outputs.latest_version }}\`)" >> $GITHUB_STEP_SUMMARY
      
      - name: Cleanup
        if: always()
        run: |
          rm -f cribl-docs.html
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” Cribl API Version Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Found Version** | \`${{ steps.extract-version.outputs.version || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Latest Release** | \`${{ steps.latest-release.outputs.latest_version || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Triggered** | ${{ steps.compare.outputs.needs_build == 'true' && 'âœ… Yes' || 'âŒ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Spec URL** | ${{ steps.extract-version.outputs.spec_url || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.compare.outputs.needs_build }}" == "true" ]; then
            echo "ðŸš€ **Action Taken**: Triggered [build-release workflow](https://github.com/${{ github.repository }}/actions/workflows/build-release.yml)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Action Taken**: No build required - already at latest version" >> $GITHUB_STEP_SUMMARY
          fi

